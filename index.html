<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎮 لعبة أسئلة الأطفال — v3.2 (Fix)</title>
  <style>
    :root{
      --bg:#f0f8ff; --card:#ffffff; --ink:#17223b; --muted:#6b7280; --accent:#10b981; --danger:#ef4444; --brand:#3b82f6; --sky:#aee7ff;
      --shadow:0 15px 30px rgba(23,34,59,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Cairo,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--ink);font-size:2rem}

    /* شاشة البداية */
    #start{position:fixed;inset:0;background:linear-gradient(180deg,var(--bg),var(--sky));display:flex;align-items:center;justify-content:center;padding:30px;z-index:1000}
    .start-card{max-width:900px;width:100%;background:#ffffffcc;backdrop-filter:blur(6px);border-radius:30px;box-shadow:var(--shadow);padding:40px;text-align:center}
    .start-title{font-size:3.2rem;margin:0 0 10px}
    .start-sub{color:#0c4a6e;margin:0 0 20px}
    .name-row{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:20px}
    .name-row input{font-size:1.8rem;padding:18px 20px;border-radius:16px;border:2px solid #93c5fd;min-width:320px}
    .music-tip{font-size:1.2rem;color:#334155;margin-top:10px}

    .container{max-width:1800px;margin:auto;padding:60px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:40px}
    h1{font-size:3rem;margin:0;display:flex;gap:20px;align-items:center}
    .chip{font-size:1.5rem;padding:16px 30px;border-radius:999px;background:#e0f2ff;color:#0c4a6e}

    .card{background:var(--card);border-radius:28px;box-shadow:var(--shadow);padding:60px}
    .row{display:flex;gap:30px;flex-wrap:wrap}
    .grow{flex:1 1 500px}

    .setup label{display:block;font-size:1.8rem;margin-bottom:16px;color:var(--muted)}
    .setup textarea{width:100%;min-height:400px;padding:30px;border:2px solid #e5e7eb;border-radius:20px;font-family:monospace;background:#fbfdff;font-size:1.6rem}
    .setup .controls{display:flex;flex-wrap:wrap;gap:30px;margin-top:30px}
    .setup input[type="number"], .setup input[type="text"]{padding:20px 25px;border-radius:15px;border:2px solid #e5e7eb;font-size:1.6rem}
    .btn{border:0;border-radius:20px;padding:25px 40px;font-weight:700;cursor:pointer;font-size:1.6rem}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.ghost{background:#e0f2ff;color:#0c4a6e}

    .hud{display:flex;justify-content:space-between;align-items:center;gap:25px;margin-bottom:30px;font-size:1.8rem}
    .hud .pill{background:#f1f5f9;color:#334155;padding:15px 30px;border-radius:999px}
    .progress{height:25px;background:#e0f2ff;border-radius:999px;overflow:hidden;margin-bottom:40px}
    .progress>div{height:100%;background:linear-gradient(90deg,#34d399,#10b981);width:0%}

    .question{font-size:3rem;font-weight:800;margin:30px 0 40px;text-align:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:40px}

    .choice{position:relative;border:5px solid transparent;border-radius:30px;background:#ffffff;cursor:pointer;transition:.3s;box-shadow:0 15px 35px rgba(17,24,39,.15);font-size:2rem}
    .choice:hover{transform:translateY(-6px)}
    .choice.is-correct{border-color:var(--accent)}
    .choice.is-wrong{border-color:var(--danger)}
    .choice .thumb{height:350px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:25px 25px 0 0;overflow:hidden}
    .choice .thumb img{max-width:100%;max-height:100%}
    .choice .label{padding:25px 30px;font-weight:700;text-align:center;font-size:2rem}

    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:40px;color:var(--muted);font-size:1.8rem}

    .result{display:none;text-align:center;padding:60px;font-size:2rem}
    .result h2{font-size:3.2rem;margin:0 0 30px}
    .result .stats{display:flex;flex-wrap:wrap;gap:30px;justify-content:center;margin-top:30px}
    .stat{background:#f8fafc;border:2px solid #e0f2ff;border-radius:25px;padding:25px 35px;font-size:1.8rem}

    .happy-img, .sad-img {position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 999; width: min(500px, 70vw); height: auto; max-height: 70vh}

    #clapOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(240,248,255,.6);z-index:1100}
    #clapOverlay img{width:420px;height:420px;animation:pulse .7s ease-in-out infinite alternate}
    #feedbackOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.35);z-index:1100}
    #feedbackOverlay .box{background:#fff;border-radius:28px;box-shadow:var(--shadow);padding:30px 36px;text-align:center;max-width:720px}
    #feedbackOverlay img{width:280px;height:280px;object-fit:contain}
    #feedbackOverlay .msg{margin-top:16px;color:#0f172a;font-weight:700}
    @keyframes pulse{from{transform:scale(.92)}to{transform:scale(1.06)}}

    @media (max-width: 640px){
      body{font-size:1.4rem}
      .container{padding:calc(18px + env(safe-area-inset-left));}
      header{flex-direction:column;gap:10px;align-items:flex-start}
      h1{font-size:2.2rem}
      .chip{font-size:1.2rem;padding:10px 16px}
      .card{padding:22px}
      .hud{flex-direction:column;gap:12px;align-items:stretch}
      .progress{height:14px;margin-bottom:18px}
      .question{font-size:2rem;margin:18px 0}
      .grid{grid-template-columns:repeat(2,1fr);gap:16px}
      .choice{border-width:3px;border-radius:18px;padding-bottom:6px}
      .choice .thumb{height:170px}
      .choice .label{padding:12px 10px;font-size:1.4rem}
      .footer{flex-direction:column;gap:10px;align-items:stretch;margin-top:16px}
      .btn{width:100%;padding:16px 18px;font-size:1.2rem}
      .start-card{padding:24px;max-width:95vw}
      .name-row{flex-direction:column}
      .name-row input{min-width:unset;width:100%}
    }
  </style>
</head>
<body>
  <!-- شاشة البداية -->
  <section id="start">
    <div class="start-card">
      <div style="font-size:4rem">🌟</div>
      <h2 class="start-title">لعبة الأسئلة الممتعة للأطفال</h2>
      <p class="start-sub">مرحبًا بك! اكتب اسمك ثم اضغط ابدأ اللعب</p>
      <div class="name-row">
        <input id="playerName" type="text" placeholder="اكتب اسمك يا بطل" />
        <button class="btn primary" id="goBtn">ابدأ اللعب</button>
      </div>
      <div class="music-tip">يمكنك كتم الصوت لاحقًا من الزر أعلى الصفحة.</div>
    </div>
  </section>

  <div class="container">
    <header>
      <h1>🎮 لعبة أسئلة الأطفال <span class="chip">v3.2</span></h1>
      <button class="btn ghost" id="muteBtn" title="كتم/تشغيل الصوت">🔊 الصوت</button>
    </header>

    <section id="setup" class="card setup" style="display:none">
      <div class="row">
        <div class="grow">
          <label>أسئلة اللعبة (JSON):</label>
          <textarea id="questionsJson" spellcheck="false">[
  {"question":"ما الحيوان الذي يقول مواء؟","answers":[{"text":"قطة","image":"https://cdn-icons-png.flaticon.com/512/1998/1998592.png","isCorrect":true},{"text":"كلب","image":"https://cdn-icons-png.flaticon.com/512/1998/1998673.png","isCorrect":false},{"text":"بقرة","image":"https://cdn-icons-png.flaticon.com/512/1998/1998610.png","isCorrect":false}]},
  {"question":"ما الفاكهة التي لونها أصفر؟","answers":[{"text":"موز","image":"https://cdn-icons-png.flaticon.com/512/415/415733.png","isCorrect":true},{"text":"تفاح","image":"https://cdn-icons-png.flaticon.com/512/742/742751.png","isCorrect":false},{"text":"عنب","image":"https://cdn-icons-png.flaticon.com/512/766/766013.png","isCorrect":false}]},
  {"question":"أين نرى القمر؟","answers":[{"text":"في السماء","image":"https://cdn-icons-png.flaticon.com/512/1146/1146869.png","isCorrect":true},{"text":"في البحر","image":"https://cdn-icons-png.flaticon.com/512/3075/3075977.png","isCorrect":false},{"text":"على الأرض","image":"https://cdn-icons-png.flaticon.com/512/9131/9131530.png","isCorrect":false}]},
  {"question":"ما الشيء الذي نستخدمه في الكتابة؟","answers":[{"text":"قلم","image":"https://cdn-icons-png.flaticon.com/512/2647/2647789.png","isCorrect":true},{"text":"ممحاة","image":"https://cdn-icons-png.flaticon.com/512/4221/4221403.png","isCorrect":false},{"text":"مقص","image":"https://cdn-icons-png.flaticon.com/512/3131/3131607.png","isCorrect":false}]},
  {"question":"ما الحيوان الذي يطير؟","answers":[{"text":"طائر","image":"https://cdn-icons-png.flaticon.com/512/1998/1998617.png","isCorrect":true},{"text":"أسد","image":"https://cdn-icons-png.flaticon.com/512/1998/1998627.png","isCorrect":false},{"text":"سمكة","image":"https://cdn-icons-png.flaticon.com/512/1998/1998676.png","isCorrect":false}]},
  {"question":"ما لون العشب؟","answers":[{"text":"أخضر","image":"https://cdn-icons-png.flaticon.com/512/2913/2913399.png","isCorrect":true},{"text":"أزرق","image":"https://cdn-icons-png.flaticon.com/512/2913/2913382.png","isCorrect":false},{"text":"أحمر","image":"https://cdn-icons-png.flaticon.com/512/2913/2913385.png","isCorrect":false}]},
  {"question":"ما وسيلة النقل التي تطير في السماء؟","answers":[{"text":"طائرة","image":"https://cdn-icons-png.flaticon.com/512/3078/3078951.png","isCorrect":true},{"text":"سيارة","image":"https://cdn-icons-png.flaticon.com/512/743/743007.png","isCorrect":false},{"text":"دراجة","image":"https://cdn-icons-png.flaticon.com/512/201/201818.png","isCorrect":false}]},
  {"question":"أين نعيش نحن البشر؟","answers":[{"text":"على الأرض","image":"https://cdn-icons-png.flaticon.com/512/9131/9131530.png","isCorrect":true},{"text":"في القمر","image":"https://cdn-icons-png.flaticon.com/512/869/869869.png","isCorrect":false},{"text":"في البحر","image":"https://cdn-icons-png.flaticon.com/512/3075/3075977.png","isCorrect":false}]},
  {"question":"ما الحيوان الذي يعيش في الماء وله ذيل؟","answers":[{"text":"سمكة","image":"https://cdn-icons-png.flaticon.com/512/1998/1998676.png","isCorrect":true},{"text":"نمر","image":"https://cdn-icons-png.flaticon.com/512/1998/1998679.png","isCorrect":false},{"text":"جمل","image":"https://cdn-icons-png.flaticon.com/512/1998/1998612.png","isCorrect":false}]},
  {"question":"ما الشيء الذي نستخدمه لنشرب الماء؟","answers":[{"text":"كوب","image":"https://cdn-icons-png.flaticon.com/512/1047/1047505.png","isCorrect":true},{"text":"طبق","image":"https://cdn-icons-png.flaticon.com/512/706/706164.png","isCorrect":false},{"text":"ملعقة","image":"https://cdn-icons-png.flaticon.com/512/706/706195.png","isCorrect":false}]}
]</textarea>
          <div class="controls">
            <input id="limit" type="number" min="1" step="1" placeholder="عدد الأسئلة (اختياري)" />
            <button class="btn primary" id="startBtn">ابدأ الاختبار الآن</button>
          </div>
        </div>
      </div>
    </section>

    <section id="game" class="card" style="display:none">
      <div class="hud">
        <div class="pill" id="timer">⏱️ 00:00</div>
        <div class="pill" id="firstTry">من أول مرة: 0</div>
        <div class="pill" id="wrongHud">❌ غير من أول مرة: 0 (0%)</div>
        <div class="pill" id="qIndex">السؤال 1/1</div>
      </div>
      <div class="progress"><div id="progressBar"></div></div>
      <div class="question" id="questionText">…</div>
      <div class="grid" id="choices"></div>
      <div class="footer">
        <div>اختر الإجابة الصحيحة. عند الخطأ يمكنك المحاولة مرة أخرى.</div>
        <button class="btn ghost" id="restart">🔁 إعادة من البداية</button>
      </div>
    </section>

    <section id="result" class="card result">
      <h2 id="resultTitle">🎉 أحسنت! لقد أنهيت جميع الأسئلة</h2>
      <p id="resultText">…</p>
      <div class="stats">
        <div class="stat">⏱️ الوقت المستغرق: <b id="resultTime">00:00</b></div>
        <div class="stat">✅ من أول محاولة: <b id="resultFirstTries">0</b></div>
        <div class="stat">📚 عدد الأسئلة: <b id="resultTotal">0</b></div>
        <div class="stat">❌ أسئلة لم تُجب من أول مرة: <b id="resultWrongCount">0</b></div>
        <div class="stat">📊 النسبة المئوية للأسئلة الخاطئة: <b id="resultWrongPercent">0%</b></div>
      </div>
      <div style="margin-top:40px;display:flex;gap:30px;justify-content:center">
        <button class="btn primary" id="playAgain">🎯 العب مرة أخرى</button>
        <button class="btn ghost" id="backToSetup">⚙️ رجوع للإعداد</button>
      </div>
    </section>
  </div>

  <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="happy-img" id="happyImg" alt="happy boy">
  <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" class="sad-img" id="sadImg" alt="sad boy">
  <div id="clapOverlay"><img src="https://cdn-icons-png.flaticon.com/512/3159/3159310.png" alt="تصفيق"></div>
  <div id="feedbackOverlay"><div class="box"><img id="feedbackImg" src="" alt="تشجيع"><div id="feedbackMsg" class="msg"></div><button id="feedbackOk" class="btn primary" style="margin-top:18px">حسنًا</button></div></div>

  <script>
    // لا نستخدم أي تعبيرات منتظمة هنا لتفادي الخطأ
    function qs(sel, root){ return (root||document).querySelector(sel); }
    function shuffle(arr){ return arr.slice().sort(function(){ return Math.random()-0.5; }); }

    var QUESTIONS=[], current=0, firstTryCount=0, startAt=0, firstAttempt=true, playerName='', wrongCount=0, isMuted=false;

    // موسيقى خلفية بسيطة
    var BGM=(function(){
      var ctx = (window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)() : null;
      var interval=null;
      function tone(f,d,v){ if(isMuted||!ctx) return; var o=ctx.createOscillator(); var g=ctx.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0,ctx.currentTime); g.gain.linearRampToValueAtTime(v, ctx.currentTime+0.05); g.gain.linearRampToValueAtTime(0.0001, ctx.currentTime+d); o.start(); o.stop(ctx.currentTime+d); }
      function tick(){ [523.25,659.25,783.99].forEach(function(f,i){ setTimeout(function(){ tone(f,0.35,0.05); }, i*180); }); }
      return { start:function(){ if(isMuted||!ctx) return; if(ctx.state==='suspended') ctx.resume(); if(interval) return; tick(); interval=setInterval(tick,1500); }, stop:function(){ if(interval){ clearInterval(interval); interval=null; } } };
    })();

    var timerEl=qs('#timer'), firstTryEl=qs('#firstTry'), qIndexEl=qs('#qIndex'), progressBar=qs('#progressBar');
    var timerId=null; function fmtTime(ms){ var s=Math.floor(ms/1000), m=Math.floor(s/60), r=s%60; return (m<10?'0'+m:m)+':' + (r<10?'0'+r:r); }
    function startTimer(){ startAt=performance.now(); tick(); }
    function tick(){ timerEl.textContent='⏱️ '+fmtTime(performance.now()-startAt); timerId=requestAnimationFrame(tick); }
    function stopTimer(){ if(timerId) cancelAnimationFrame(timerId); timerId=null; }
    function playSound(src){ if(isMuted) return; var a=new Audio(src); a.play(); }

    var happyImg=qs('#happyImg');
    var sadImg=qs('#sadImg');
    var clapOverlay=qs('#clapOverlay');
    var feedbackOverlay=qs('#feedbackOverlay');
    var feedbackImg=qs('#feedbackImg');
    var feedbackMsg=qs('#feedbackMsg');
    var feedbackOk=qs('#feedbackOk'); if(feedbackOk){ feedbackOk.onclick=function(){ feedbackOverlay.style.display='none'; }; }

    function showHappy(){ happyImg.style.display='block'; setTimeout(function(){ happyImg.style.display='none'; }, 2000); }
    function showSad(){ sadImg.style.display='block'; setTimeout(function(){ sadImg.style.display='none'; }, 2000); }
    function showClap(){ clapOverlay.style.display='flex'; setTimeout(function(){ clapOverlay.style.display='none'; }, 1600); }
    function showFeedback(img, msg){ feedbackImg.src=img; feedbackMsg.textContent=msg; feedbackOverlay.style.display='flex'; }

    function updateHud(){
      var answeredSoFar = current;
      var wrongSoFar = Math.max(0, answeredSoFar - firstTryCount);
      var wrongPercent = answeredSoFar>0 ? Math.round((wrongSoFar/answeredSoFar)*100) : 0;
      qIndexEl.textContent='السؤال ' + Math.min(current+1, QUESTIONS.length) + '/' + QUESTIONS.length;
      firstTryEl.textContent='من أول مرة: ' + firstTryCount;
      var wrongHud=qs('#wrongHud'); if(wrongHud) wrongHud.textContent='❌ غير من أول مرة: ' + wrongSoFar + ' (' + wrongPercent + '%)';
      progressBar.style.width = Math.round((current/QUESTIONS.length)*100) + '%';
    }

    function renderQuestion(){
      var q=QUESTIONS[current];
      if(!q){ finish(); return; }
      qs('#questionText').textContent=q.question;
      var host=qs('#choices'); host.innerHTML=''; wrongCount=0;
      (q.answers||[]).forEach(function(a){
        var b=document.createElement('button'); b.className='choice';
        var imgHtml = a.image ? "<img src='"+a.image+"' alt='"+a.text+"'>" : '🎲';
        b.innerHTML = "<div class='thumb'>"+imgHtml+"</div><div class='label'>"+a.text+"</div>";
        b.onclick=function(){ onAnswer(b, !!a.isCorrect); };
        host.appendChild(b);
      });
      updateHud(); firstAttempt=true;
    }

    function onAnswer(btn, ok){
      if(ok){
        btn.classList.add('is-correct');
        if(firstAttempt) firstTryCount++;
        showHappy(); showClap(); playSound('https://www.soundjay.com/human/applause-2.mp3');
        setTimeout(function(){ current++; renderQuestion(); if(current>QUESTIONS.length-1) finish(); }, 1600);
      } else {
        btn.classList.add('is-wrong'); firstAttempt=false; wrongCount++;
        if(wrongCount===1){ showFeedback('https://cdn-icons-png.flaticon.com/512/4140/4140048.png', 'لا بأس، حاول مرة أخرى'); playSound('https://www.soundjay.com/buttons/sounds/button-10.mp3'); }
        else if(wrongCount===2){ showFeedback('https://cdn-icons-png.flaticon.com/512/4140/4140051.png', 'أثق فيك، حاول مرة أخرى يا بطل'); playSound('https://www.soundjay.com/buttons/sounds/button-7.mp3'); }
        else { showFeedback('https://cdn-icons-png.flaticon.com/512/4140/4140031.png', 'يمكن الاجتهاد والجد في المرة القادمة'); playSound('https://www.soundjay.com/human/sad-trombone-2.mp3'); setTimeout(function(){ feedbackOverlay.style.display='none'; current++; renderQuestion(); }, 1800); }
        setTimeout(function(){ btn.classList.remove('is-wrong'); }, 800);
      }
    }

    function finish(){
      stopTimer();
      var total=QUESTIONS.length||1;
      var wrongCountOverall = total - firstTryCount;
      var wrongPercent = Math.round((wrongCountOverall/total)*100);
      qs('#resultTime').textContent=fmtTime(performance.now()-startAt);
      qs('#resultFirstTries').textContent=firstTryCount;
      qs('#resultTotal').textContent=total;
      qs('#resultWrongCount').textContent=wrongCountOverall;
      qs('#resultWrongPercent').textContent=wrongPercent + '%';
      var congratsName = playerName ? ('أحسنت يا ' + playerName + '!') : 'أحسنت!';
      qs('#resultTitle').textContent = '🎉 ' + congratsName + ' لقد أنهيت جميع الأسئلة';
      qs('#resultText').textContent = (firstTryCount===total) ? 'مذهل! أجبت على جميع الأسئلة من أول مرة 👏' : 'أحسنت! واصل التدريب لتحقق نتيجة أعلى.';
      qs('#game').style.display='none';
      qs('#result').style.display='block';
      playSound('https://www.soundjay.com/human/kids-cheering.mp3');
      if(!isMuted) BGM.start();
    }

    // بدء اللعبة من شاشة الإعداد
    qs('#startBtn').onclick=function(){
      var data; try{ data=JSON.parse(qs('#questionsJson').value); } catch(e){ alert('JSON غير صالح'); return; }
      if(!data || !data.length) return; var limit=parseInt(qs('#limit').value||data.length,10);
      QUESTIONS = shuffle(data).slice(0,limit).map(function(q){ q.answers = shuffle(q.answers); return q; });
      current=0; firstTryCount=0; firstAttempt=true;
      qs('#setup').style.display='none'; qs('#game').style.display='block'; BGM.stop(); startTimer(); renderQuestion();
    };

    // أزرار ثانوية
    qs('#restart').onclick=function(){ current=0; firstTryCount=0; firstAttempt=true; renderQuestion(); };
    qs('#playAgain').onclick=function(){ qs('#result').style.display='none'; qs('#setup').style.display='block'; };
    qs('#backToSetup').onclick=function(){ qs('#result').style.display='none'; qs('#setup').style.display='block'; };

    // شاشة البداية
    qs('#goBtn').onclick=function(){
      var nameVal = qs('#playerName').value || 'بطلي';
      playerName = String(nameVal).trim();
      alert('مرحبًا يا ' + playerName + '! حان وقت المرح والتعلم!');
      qs('#start').style.display='none';
      qs('#setup').style.display='block';
      if(!isMuted) BGM.start();
    };

    // زر كتم/تشغيل الصوت
    var muteBtn=qs('#muteBtn');
    function refreshMuteUI(){ muteBtn.textContent = isMuted ? '🔇 صامت' : '🔊 الصوت'; }
    muteBtn.onclick=function(){ isMuted = !isMuted; if(isMuted){ BGM.stop(); } else { if(qs('#setup').style.display!=='none' || qs('#result').style.display!=='none'){ BGM.start(); } } refreshMuteUI(); };
    refreshMuteUI();
  </script>
</body>
</html>